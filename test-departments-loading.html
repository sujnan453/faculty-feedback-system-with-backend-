<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Test Departments Loading</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        button {
            padding: 10px 20px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>üîç Departments Loading Test</h1>

    <button onclick="testDepartments()">Test Load Departments</button>
    <button onclick="testFeedbacks()">Test Load Feedbacks</button>

    <div id="result"></div>

    <script type="module">
        import Storage from './js/firebase-storage.js';
        import { checkAuth } from './js/firebase-auth.js';
        
        window.Storage = Storage;
        window.checkAuth = checkAuth;

        window.testDepartments = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">Loading...</div>';
            
            try {
                console.log('Testing Storage.getDepartments()...');
                const departments = await Storage.getDepartments();
                console.log('Departments:', departments);
                
                let html = `<div class="result success">
                    <h3>‚úÖ Success! Found ${departments.length} departments:</h3>
                    <ul>`;
                
                departments.forEach(dept => {
                    html += `<li><strong>${dept.name}</strong> (ID: ${dept.id}, Faculties: ${dept.faculties ? dept.faculties.length : 0})</li>`;
                });
                
                html += '</ul></div>';
                resultDiv.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<div class="result error">
                    <h3>‚ùå Error loading departments:</h3>
                    <p>${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>`;
            }
        };

        window.testFeedbacks = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">Loading...</div>';
            
            try {
                console.log('Testing Storage.getFeedbacks()...');
                const feedbacks = await Storage.getFeedbacks();
                console.log('Feedbacks:', feedbacks.length);
                
                // Group by department
                const byDept = {};
                feedbacks.forEach(f => {
                    const dept = f.studentDepartment || f.department || 'Unknown';
                    if (!byDept[dept]) byDept[dept] = 0;
                    byDept[dept]++;
                });
                
                let html = `<div class="result success">
                    <h3>‚úÖ Success! Found ${feedbacks.length} feedbacks:</h3>
                    <ul>`;
                
                Object.keys(byDept).sort().forEach(dept => {
                    html += `<li><strong>${dept}</strong>: ${byDept[dept]} feedbacks</li>`;
                });
                
                html += '</ul></div>';
                resultDiv.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<div class="result error">
                    <h3>‚ùå Error loading feedbacks:</h3>
                    <p>${error.message}</p>
                </div>`;
            }
        };

        // Auto-test on load
        setTimeout(() => {
            console.log('Auto-testing departments...');
            testDepartments();
        }, 1000);
    </script>
</body>

</html>